<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welcome to PuzzlePath!</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <script>
    // Apply theme immediately to prevent flash of unstyled content
    (function() {
      const theme = localStorage.getItem('zip_theme') || 'christmas';
      document.body.classList.add('theme-' + theme);
      
      // Redirect to login if not logged in
      const user = localStorage.getItem("zip_currentUser");
      if (!user) {
        window.location.href = "/login";
      }
    })();
  </script>
  <main class="wrap">
    <section class="card">
      <div class="user-header">
        <span class="user-info">Welcome, <strong id="currentUsername"></strong>!</span>
        <div style="display:flex;gap:8px">
          <a href="/rankings" class="btn-logout">Rankings</a>
          <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
      </div>

      <!-- Theme Selector -->
      <div class="theme-selector">
        <div class="theme-selector-title">Select Theme</div>
        <div class="theme-options">
          <button class="theme-option" data-theme="christmas">
            Christmas
          </button>
          <button class="theme-option" data-theme="flowers">
            Tan & Flowers
          </button>
          <button class="theme-option" data-theme="geometry">
            Geometry Dash
          </button>
          <button class="theme-option" data-theme="pacman">
            Pacman
          </button>
        </div>
      </div>

      <h1>Welcome to PuzzlePath!</h1>
      <p class="subtitle">Drag from 1 → 2 → 3 → … Cover every cell!</p>

      <div id="dashboard" class="dashboard"></div>

      <div class="list" id="zipList">
        <span class="msg">Loading zips…</span>
      </div>
    </section>
  </main>

  <script>
    // =====================
    // Auth State Management
    // =====================
    function getCurrentUser() {
      return localStorage.getItem("zip_currentUser");
    }

    function getUserData(user) {
      if (!user) return { opened: {}, completed: {}, startTimes: {}, times: {} };
      const raw = localStorage.getItem(`zip_user_${user}`);
      try {
        return raw ? JSON.parse(raw) : { opened: {}, completed: {}, startTimes: {}, times: {} };
      } catch {
        return { opened: {}, completed: {}, startTimes: {}, times: {} };
      }
    }

    function saveUserData(user, data) {
      if (!user) return;
      localStorage.setItem(`zip_user_${user}`, JSON.stringify(data));
    }
    
    // Sync user data from server to localStorage
    async function syncUserDataFromServer(username) {
      try {
        const res = await fetch(`/api/progress/${encodeURIComponent(username)}`);
        if (res.ok) {
          const serverData = await res.json();
          const localData = getUserData(username);
          
          // Merge server data with local data (server takes precedence for completed puzzles)
          const mergedData = {
            opened: { ...localData.opened, ...serverData.opened },
            completed: { ...localData.completed, ...serverData.completed },
            times: { ...localData.times, ...serverData.times },
            startTimes: localData.startTimes || {}
          };
          
          saveUserData(username, mergedData);
          console.log('✓ Synced user data from server');
          return true;
        }
      } catch (err) {
        console.warn('Failed to sync user data from server:', err);
      }
      return false;
    }

    function markOpenedForUser(user, id) {
      if (!user) return;
      const d = getUserData(user);
      d.opened = d.opened || {};
      d.opened[id] = true;
      saveUserData(user, d);
    }

    // =====================
    // Logout Handler
    // =====================
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem("zip_currentUser");
      window.location.href = "/login";
    });

    // =====================
    // Load Puzzles
    // =====================
    async function loadZips() {
      const list = document.getElementById("zipList");
      list.innerHTML = `<span class="msg">Loading zips…</span>`;

      try {
        const res = await fetch("puzzles.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load puzzles.json (${res.status})`);

        const data = await res.json();
        const zips = Array.isArray(data.zips) ? data.zips.slice() : [];
        zips.sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0));

        list.innerHTML = "";

        if (zips.length === 0) {
          list.innerHTML = `<span class="msg bad">No zips found</span>`;
          return;
        }

        const currentUser = getCurrentUser();
        const userData = getUserData(currentUser);

        // Render dashboard
        const dash = document.getElementById("dashboard");

        function fmtMs(ms) {
          if (ms == null) return "—";
          const s = Math.floor(ms / 1000);
          const rem = Math.floor(ms % 1000);
          return `${s}.${String(rem).padStart(3, '0')}s`;
        }

        // Prepare completed times
        const completedEntries = [];
        for (const zidStr of Object.keys(userData.times || {})) {
          const zid = Number(zidStr);
          const ms = userData.times[zidStr];
          const meta = zips.find(z => Number(z.id) === zid);
          const n = Array.isArray(meta?.grid) ? meta.grid.length : null;
          const numbersCount = meta ? meta.grid.flat().filter(x => x !== 0).length : null;
          if (ms != null && meta) completedEntries.push({ id: zid, ms, n, numbersCount });
        }

        // Stats
        const timesSorted = completedEntries.map(e => e.ms).sort((a, b) => a - b);
        const avg = timesSorted.length ? Math.round(timesSorted.reduce((a, b) => a + b, 0) / timesSorted.length) : null;
        const median = timesSorted.length ? (timesSorted.length % 2 === 1 ? timesSorted[(timesSorted.length - 1) / 2] : Math.round((timesSorted[timesSorted.length / 2 - 1] + timesSorted[timesSorted.length / 2]) / 2)) : null;

        dash.innerHTML = `
          <div class="title">Your Stats</div>
          <div class="row">
            <div class="stat">Average: ${fmtMs(avg)}</div>
            <div class="stat">Median: ${fmtMs(median)}</div>
            <div class="stat">Completed: ${timesSorted.length} / ${zips.length}</div>
          </div>
        `;

        // Render puzzle buttons
        for (const z of zips) {
          const n = Array.isArray(z.grid) ? z.grid.length : 0;
          const a = document.createElement("a");
          a.className = "btn";
          a.href = `/zip?id=${encodeURIComponent(z.id)}`;
          a.dataset.id = String(z.id);
          a.textContent = `Zip #${z.id}${n ? ` (${n}×${n})` : ""}`;

          if (userData.opened && userData.opened[z.id]) a.classList.add("seen");
          if (userData.completed && userData.completed[z.id]) a.classList.add("completed");

          a.addEventListener("click", () => {
            const user = getCurrentUser();
            if (user) markOpenedForUser(user, z.id);
          });

          list.appendChild(a);
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = `<span class="msg bad">Could not load puzzles. Make sure server is running.</span>`;
      }
    }

    // =====================
    // Theme Management
    // =====================
    function getTheme() {
      return localStorage.getItem('zip_theme') || 'christmas';
    }

    function setTheme(theme) {
      localStorage.setItem('zip_theme', theme);
      applyTheme(theme);
    }

    function applyTheme(theme) {
      document.body.classList.remove('theme-flowers', 'theme-geometry', 'theme-pacman', 'theme-christmas');
      document.body.classList.add('theme-' + theme);
      
      // Update active state on theme buttons
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
    }

    // Theme button click handlers
    document.querySelectorAll('.theme-option').forEach(btn => {
      btn.addEventListener('click', () => {
        setTheme(btn.dataset.theme);
      });
    });

    // =====================
    // Initialize
    // =====================
    document.addEventListener('DOMContentLoaded', async () => {
      const user = getCurrentUser();
      if (!user) {
        window.location.href = "/login";
        return;
      }
      
      document.getElementById('currentUsername').textContent = user;
      applyTheme(getTheme());
      
      // Sync data from server, then load zips
      await syncUserDataFromServer(user);
      loadZips();
    });
  </script>
</body>
</html>
